# Lead Triage System ๐ฏ

ะะฒัะพะผะฐัะธะทะธัะพะฒะฐะฝะฝะฐั ัะธััะตะผะฐ ะดะปั ัะพััะธัะพะฒะบะธ ะธ ะฐะฝะฐะปะธะทะฐ ะฟะพัะตะฝัะธะฐะปัะฝัั ะบะปะธะตะฝัะพะฒ (ะปะธะดะพะฒ) ั ะผะธะบัะพัะตัะฒะธัะฝะพะน ะฐััะธัะตะบัััะพะน.

## ะฃะดะพะฑะฝะตะต ะฒัะตะณะพ ะฟัะพะฒะตัััั ะฒ Postman, ััะพ ั ะธ ัะดะตะปะฐะป, ะฝะฐะณะปัะดะฝะพ ะผะพะถะฝะพ ัะฒะธะดะตัั ััะพ ะฒะพะทะฒัะฐัะฐะตั ะฐะฟะธ, ััะฐัััั ะพัะฒะตัะพะฒ, ะธ ะบะฐะบ ัะตะฑั ะฒะตะดะตั ะบะพะด

## ๐ ะงัะพ ัะตะฐะปะธะทะพะฒะฐะฝะพ

### โ ะัะฝะพะฒะฝะฐั ััะฝะบัะธะพะฝะฐะปัะฝะพััั
- **ะัะธะตะผ ะปะธะดะพะฒ** ัะตัะตะท REST API ั ะฒะฐะปะธะดะฐัะธะตะน ะดะฐะฝะฝัั
- **ะะฒัะพะผะฐัะธัะตัะบะธะน ะฐะฝะฐะปะธะท** ะฝะฐะผะตัะตะฝะธะน ะธ ะฟัะธะพัะธัะธะทะฐัะธั
- **ะัะธะฝััะพะฝะฝะฐั ะพะฑัะฐะฑะพัะบะฐ** ัะตัะตะท ะพัะตัะตะดะธ Redis
- **ะะธะบัะพัะตัะฒะธัะฝะฐั ะฐััะธัะตะบัััะฐ** (3 ัะตัะฒะธัะฐ + Redis)

### โ ะะฐะดะตะถะฝะพััั ะธ ะฑะตะทะพะฟะฐัะฝะพััั
- **ะะดะตะผะฟะพัะตะฝัะฝะพััั ะทะฐะฟัะพัะพะฒ** - ะดัะฑะปะธััััะธะต ะทะฐะฟัะพัั ั ะพะดะฝะธะผ `Idempotency-Key` ะฒะพะทะฒัะฐัะฐัั ัะพั ะถะต ัะตะทัะปััะฐั
- **ะะตะดัะฟะปะธะบะฐัะธั ัะพะฑััะธะน** - ะฟัะตะดะพัะฒัะฐัะตะฝะธะต ะฟะพะฒัะพัะฝะพะน ะพะฑัะฐะฑะพัะบะธ ะพะดะธะฝะฐะบะพะฒัั ัะพะฑััะธะน ะฒ ะพัะตัะตะดะธ
- **ะะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั** ัะตัะตะท Pydantic ะผะพะดะตะปะธ
- **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ** ั retry ะผะตัะฐะฝะธะทะผะฐะผะธ

### โ ะขะตััะธัะพะฒะฐะฝะธะต
- **Unit ัะตััั** ะดะปั ะบะฐะถะดะพะณะพ ะบะพะผะฟะพะฝะตะฝัะฐ
- **Integration ัะตััั** ะดะปั ะฒะทะฐะธะผะพะดะตะนััะฒะธั ัะตัะฒะธัะพะฒ  
- **E2E ัะตััั** ะฟะพะปะฝะพะณะพ ัะธะบะปะฐ ะพะฑัะฐะฑะพัะบะธ
- **ะขะตััั ะธะดะตะผะฟะพัะตะฝัะฝะพััะธ** - ะฟัะพะฒะตัะบะฐ ะฟะพะฒัะพัะฝัั ะทะฐะฟัะพัะพะฒ
- **ะขะตััั ะดะตะดัะฟะปะธะบะฐัะธะธ** - ะฟัะตะดะพัะฒัะฐัะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ ะฒ ะพัะตัะตะดะธ

## ๐ ะะดะตะผะฟะพัะตะฝัะฝะพััั

### ะะดะต ัะตะฐะปะธะทะพะฒะฐะฝะฐ
- **Intake API**: Header `Idempotency-Key` ะดะปั POST `/api/leads`
- **ะะฐะทะฐ ะดะฐะฝะฝัั**: ะฃะฝะธะบะฐะปัะฝัะต ะธะฝะดะตะบัั ะฝะฐ `idempotency_key` ะธ `email`
- **ะะพะณะธะบะฐ**: ะะพะฒัะพัะฝัะต ะทะฐะฟัะพัั ะฒะพะทะฒัะฐัะฐัั ัััะตััะฒัััะธะน ัะตะทัะปััะฐั

### ะะฐะบ ัะฐะฑะพัะฐะตั
```bash
# ะะตัะฒัะน ะทะฐะฟัะพั
curl -X POST http://localhost:8000/api/leads \
  -H "Idempotency-Key: unique-123" \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "name": "Test User"}'
# ะัะฒะตั: 201 Created

# ะะพะฒัะพัะฝัะน ะทะฐะฟัะพั ั ัะตะผ ะถะต ะบะปััะพะผ
curl -X POST http://localhost:8000/api/leads \
  -H "Idempotency-Key: unique-123" \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "name": "Test User"}'
# ะัะฒะตั: 200 OK (ัะพั ะถะต ัะตะทัะปััะฐั)
```

### ะัะพะฒะตัะตะฝะพ ัะตััะฐะผะธ
- `tests/test_idempotency.py` - ะดะตัะฐะปัะฝัะต ัะตััั ะธะดะตะผะฟะพัะตะฝัะฝะพััะธ
- `tests/test_e2e.py::test_idempotency_same_request` - E2E ะฟัะพะฒะตัะบะฐ

## ๐ซ ะะตะดัะฟะปะธะบะฐัะธั ัะพะฑััะธะน

### ะะดะต ัะตะฐะปะธะทะพะฒะฐะฝะฐ
- **Triage Worker**: ะัะพะฒะตัะบะฐ `content_hash` ะฟะตัะตะด ะพะฑัะฐะฑะพัะบะพะน
- **ะะฐะทะฐ ะดะฐะฝะฝัั**: ะขะฐะฑะปะธัะฐ `insights` ั ะฟะพะปะตะผ `content_hash`
- **ะะปะณะพัะธัะผ**: SHA256 ัะตั ะบะพะฝัะตะฝัะฐ ัะพะฑััะธั

## ๐๏ธ ะกัะตะผะฐ ะฑะฐะทั ะดะฐะฝะฝัั

### ะกัััะบัััะฐ ัะฐะฑะปะธั
```sql
-- ะขะฐะฑะปะธัะฐ ะปะธะดะพะฒ
CREATE TABLE leads (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    email TEXT UNIQUE NOT NULL,
    name TEXT,
    phone TEXT,
    note TEXT,
    source TEXT,
    created_at TEXT,
    idempotency_key TEXT UNIQUE
);

-- ะขะฐะฑะปะธัะฐ ะฐะฝะฐะปะธะทะฐ (ะธะฝัะฐะนัะพะฒ)
CREATE TABLE insights (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    lead_id INTEGER,
    intent TEXT,
    priority TEXT,
    next_action TEXT,
    confidence REAL,
    content_hash TEXT,          -- ะะปั ะดะตะดัะฟะปะธะบะฐัะธะธ
    created_at TEXT,
    FOREIGN KEY (lead_id) REFERENCES leads (id)
);
```

### ะัะพะฒะตัะบะฐ ััะตะผั
- **ะะฒัะพะผะฐัะธัะตัะบะธะต ัะตััั**: `tests/test_duplicate_queue.py::test_database_schema_verification`
- **ะัะพะฒะตัะบะฐ ะบะพะปะพะฝะพะบ**: `PRAGMA table_info()` ะฒ ัะตััะฐั
- **ะะฐะปะธะดะฐัะธั ัะฒัะทะตะน**: Foreign key constraints

## ๐ ะะฐะฟััะบ ัะธััะตะผั

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ

#### 1. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
```bash
# ะะปะพะฝะธัะพะฒะฐะฝะธะต ะธ ะฝะฐัััะพะนะบะฐ
git clone https://github.com/mkcomru/lead_triage_system
cd lead_triage_system

# ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
python -m venv .venv
.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # Linux/Mac

# ะะฐะฒะธัะธะผะพััะธ
pip install -r requirements.txt
```

#### 2. ะะฐะฟััะบ Redis
```bash
# Windows (ัะตัะตะท Docker)
docker run -d -p 6379:6379 redis:alpine

# Linux/Mac
redis-server
```

#### 3. ะะฐะฟััะบ ัะตัะฒะธัะพะฒ (ะฒ ะพัะดะตะปัะฝัั ัะตัะผะธะฝะฐะปะฐั)
```bash
# Terminal 1: Intake API (Port 8000)
cd intake-api
python main.py

# Terminal 2: Insights API (Port 8001)  
cd insights-api
python main.py

# Terminal 3: Triage Worker
cd triage-worker
python main.py
```

#### 4. ะัะพะฒะตัะบะฐ ัะฐะฑะพัั
```bash
# ะกะพะทะดะฐะฝะธะต ะปะธะดะฐ
curl -X POST http://localhost:8000/leads \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com", "name": "Test User", "note": "Interested in product"}'

# ะะพะปััะตะฝะธะต ะฐะฝะฐะปะธะทะฐ (ัะตัะตะท ะฝะตัะบะพะปัะบะพ ัะตะบัะฝะด)
curl http://localhost:8001/leads/insight
```

### Docker Compose ะทะฐะฟััะบ

#### 1. ะัััััะน ััะฐัั
```bash
# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ั compose
cd deploy

# ะะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ
docker-compose up --build

# ะ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต
docker-compose up -d --build
```

## ๐งช ะะฐะฟััะบ ัะตััะพะฒ

```bash
# ะัะต ัะตััั
pytest -v

# ะะพะฝะบัะตัะฝัะต ัะตััั
pytest tests/test_e2e.py -v
pytest tests/test_idempotency.py -v  
pytest tests/test_duplicate_queue.py -v

```

### ะะตะทัะปััะฐัั ัะตััะพะฒ
- **17 ัะตััะพะฒ** ะฒะบะปััะฐั E2E, ะธะดะตะผะฟะพัะตะฝัะฝะพััั, ะดะตะดัะฟะปะธะบะฐัะธั
- **ะัะพะฒะตัะบะฐ ััะตะผั ะะ** ะฐะฒัะพะผะฐัะธัะตัะบะธ
- **Cleanup** ัะตััะพะฒัั ะดะฐะฝะฝัั ะฟะพัะปะต ะบะฐะถะดะพะณะพ ัะตััะฐ

## ๐ก API Endpoints

### Intake API (Port 8000)
- `POST /leads` - ะกะพะทะดะฐะฝะธะต ะปะธะดะฐ
- `GET /leads/{lead_id}` - ะะฝัะพ ะพ ะปะธะดะต

### Insights API (Port 8001)  
- `GET leads/{lead_id}/insight` - ะะพะปััะตะฝะธะต ะฐะฝะฐะปะธะทะฐ

## ๐ ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ   Intake API    โโโโโถโ   Redis Queue   โโโโโถโ Triage Worker   โ
โ  (Port 8000)    โ    โ  (Port 6379)    โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โ                                              โ
         โผ                                              โผ
โโโโโโโโโโโโโโโโโโโ                            โโโโโโโโโโโโโโโโโโโ
โ  SQLite DB      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  Insights API   โ
โ                 โ                            โ  (Port 8001)    โ
โโโโโโโโโโโโโโโโโโโ                            โโโโโโโโโโโโโโโโโโโ
```